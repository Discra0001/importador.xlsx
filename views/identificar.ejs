<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identificação</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
        .progress-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Tela de Identificação</h1>
        <div class="alert alert-info">
            <strong>Rede Selecionada:</strong> <%= typeof Rede !== 'undefined' ? Rede.toUpperCase() : 'BARBOSA' %>
        </div>

        <% if (lojas_a_identificar.length > 0) { %>
        <!-- Tabela para Lojas -->
        <h2 class="mt-4">Lojas a Identificar</h2>
        <form method="POST" action="/identificar-lojas">
            <input type="hidden" name="Rede" value="<%= typeof Rede !== 'undefined' ? Rede : 'barbosa' %>">
            <table class="table table-bordered table-striped mt-3">
                <thead>
                    <tr>
                        <th>DE</th>
                        <th>PARA</th>
                    </tr>
                </thead>
                <tbody>
                    <% lojas_a_identificar.forEach((loja, i) => { %>
                        <tr>
                            <td><%= loja %></td>
                            <td>
                                <input type="text" name="lojas_para[<%= loja %>]" class="form-control auto-fill-input" data-index="<%= i %>" data-type="lojas" required>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            <button type="submit" class="btn btn-primary" onclick="debugForm('lojas')">Salvar Lojas</button>
        </form>
        <% } %>


        <% if (produtos_a_identificar.length > 0) { %>
        <!-- Tabela para Produtos -->
        <h2 class="mt-4">Produtos a Identificar</h2>
        <form method="POST" action="/identificar-produtos">
            <input type="hidden" name="Rede" value="<%= typeof Rede !== 'undefined' ? Rede : 'barbosa' %>">
            <table class="table table-bordered table-striped mt-3">
                <thead>
                    <tr>
                        <th>DE</th>
                        <th>PARA</th>
                    </tr>
                </thead>
                <tbody>
                    <% produtos_a_identificar.forEach((produto, i) => { %>
                        <tr>
                            <td><%= produto %></td>
                            <td>
                                <input type="text" name="produtos_para[<%= produto %>]" class="form-control auto-fill-input" data-index="<%= i %>" data-type="produtos" required>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            <button type="submit" class="btn btn-primary" onclick="debugForm('produtos')">Salvar Produtos</button>
        </form>
        <% } %>



        <!-- Barra de progresso -->
        <div class="progress-container mt-5">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.auto-fill-input');
            
            inputs.forEach(input => {
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    
                    const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                    const lines = pastedData.split(/[\r\n]+/).filter(line => line.trim() !== '');
                    
                    if (lines.length > 1) {
                        const currentIndex = parseInt(this.dataset.index);
                        const type = this.dataset.type;
                        const currentTypeInputs = document.querySelectorAll(`[data-type="${type}"]`);
                        
                        lines.forEach((line, i) => {
                            const targetIndex = currentIndex + i;
                            if (targetIndex < currentTypeInputs.length) {
                                currentTypeInputs[targetIndex].value = line.trim();
                            }
                        });
                    } else {
                        this.value = pastedData.trim();
                    }
                });
            });
        });
        
        function debugForm(tipo) {
            console.log('=== DEBUG FORMULÁRIO ===');
            console.log('Tipo:', tipo);
            console.log('Rede do template EJS:', '<%= typeof Rede !== "undefined" ? Rede : "undefined" %>');
            console.log('Valor do input hidden Rede:', document.querySelector('input[name="Rede"]').value);
            
            const form = event.target.closest('form');
            const formData = new FormData(form);
            
            console.log('Form data enviado:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
        }
    </script>
</body>
</html>