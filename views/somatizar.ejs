<!-- somatizar.ejs -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <script>
    window.onbeforeunload = function() {
      return "A atualização da página está bloqueada.";
    };
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Somatização de Itens por Pedido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
<body style="padding: 50px;">
    <% 
    const qtdeSomatizacaoData = somatizacaoData.length; 
    var valoresTotal = 0; 
    var contI = 0; 
    var erroEncontrado = false;
    var contadorPedido = 0;
    var descontoTotal = 0;
    var descontoTotal2 = 0;
    var maxDescontoPermitido = 50; // Defina o valor máximo de desconto permitido padrão 40
    var bloqueioPorDesconto = false;
    %>
  <h1><div style="text-align: center;">Resumo dos Pedidos</div></h1>

  <div class="accordion col-md-9" id="somatizacaoCentros" style="margin-left: auto; margin-right: auto;">
    <!-- Aqui, você pode iterar sobre os centros e exibir informações para cada um deles -->
    <% for (const centro in somatizacaoData) { if (centro != 'undefined') { %>
      <div class="accordion-item" style="padding: 10px; border: none;">
        <h2 class="accordion-header" id="centro<%= centro %>">
            <button class="accordion-button"
            style="border-top-left-radius: 20px; border-top-right-radius: 20px;"
            type="button" data-bs-target="#collapse<%= centro %>" aria-expanded="false" aria-controls="collapse<%= centro %>">
            Centro: <%= centro %> |
            <% contadorPedido = contadorPedido + 1; %>
            <% const centroData = somatizacaoData[centro]; %>
            <% const totalQuantidadeSku = centroData.length %>
            <% const totalQuantidadeVolume = centroData.reduce((acc, item) => acc + item.quantidade, 0); %>
            <% const totalValor = centroData.reduce((acc, item) => acc + item.valorTotal, 0) ?? 0; %>
            Qtde de Sku's: <%= totalQuantidadeSku %> |
            Qtde de Vol: <%= totalQuantidadeVolume %> |
            Valor Total R$: <%= 1 == 1 ? totalValor != undefined && totalValor != null && totalValor > 0 ? totalValor.toFixed(2) : 0 : 0 %>
            <% var descontoPedido = 0; %>
            <% valoresTotal = valoresTotal*1 + (totalValor != undefined && totalValor != null && totalValor > 0 ? totalValor.toFixed(2)*1 : 0*1);  %>
            
            <!-- Exibir ícone com base no status 
            <% if (centroData.some(item => item.status === 'ERRO')) { %>
                <img src="https://w7.pngwing.com/pngs/285/84/png-transparent-computer-icons-error-super-8-film-angle-triangle-computer-icons.png" height="30px"  style="background-color: transparent;">
            <% } else { %>
                <img src="https://w7.pngwing.com/pngs/617/698/png-transparent-computer-icons-ok-miscellaneous-angle-grass-thumbnail.png" height="30px"  style="background-color: transparent;">
            <% } %>-->
          </button>
        </h2>
        
        <div id="collapse<%= centro %>" class="accordion-collapse collapse" aria-labelledby="centro<%= centro %>" data-bs-parent="#somatizacaoCentros">
          <div class="accordion-body">
            <!-- Aqui, você pode criar uma tabela para exibir as informações de somatização para este centro -->
           <% if (somatizacaoData['undefined'] && somatizacaoData['undefined'][contI+2] && somatizacaoData['undefined'][contI+2].numeroDoc) { %>
           <div style="font-weight: bold;">Numero do Pedido: <%= somatizacaoData['undefined'][contI+2].numeroDoc.replace('Documento de compras ', '') %></div>
           <% } else { %>
           <div style="font-weight: bold;">
             <% if (somatizacaoData[centro] && somatizacaoData[centro][0] && somatizacaoData[centro][0].numeroPedidoRedeX) { %>
               RedeX (Loja <%= centro %>) Pedido <%= somatizacaoData[centro][0].numeroPedidoRedeX %>
             <% } else { %>
               Loja: <%= centro %>
             <% } %>
           </div>
           <% } %>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>St.</th>
                  <th>SKU</th>
                  <th>Código</th>
                  <th>Descrição</th>
                  <th>Qtde</th>
                  <th>Emb.</th>
                  <th>Vl. Unit. Brt.</th>
                  <th>Vl. Unit.</th>
                  <th>Vl. Tot.</th>
                  <th>Desc R$</th>
                  <th>Desc %</th>
                </tr>
              </thead>
              <tbody>
                <% var contador = 1; %>
                <% for (const item of centroData) { %>
                    <% const produto = produtos[item.CODIGOPRODUTOINTERNO]; %>
                  <tr>
                    <td>
                      <% if (produto == undefined || produto == null || produto.INATIVO == 1) { erroEncontrado = true; %>
                          <img src="https://w7.pngwing.com/pngs/285/84/png-transparent-computer-icons-error-super-8-film-angle-triangle-computer-icons.png" height="30px"  style="background-color: transparent;">
                      <% } else { %>
                          <img src="https://w7.pngwing.com/pngs/617/698/png-transparent-computer-icons-ok-miscellaneous-angle-grass-thumbnail.png" height="30px"  style="background-color: transparent;">
                      <% } %>
                    </td>
                    <td><%= contador %></td>
                    <td><%= item.CODIGOPRODUTOINTERNO %></td>
                    <td><%= produto?.descricao ?? '' %>
                      <% if (produto == undefined || produto == null) {item.status = "ERRO";} %>
                    </td>
                    <td><%= item.quantidade %></td>
                    <td><%= item.embalagem %></td>
                    <td><%= (produto?.precoemb) %></td>
                    <td><%= item.valor %></td>
                    <td><%= item.valor * item.quantidade  %></td>
                    <td><%= ( (produto?.precoemb * item.quantidade) - (item.valor * item.quantidade)  ).toFixed(2) %></td>
                    <td><%= (((1-( item.valor / produto?.precoemb )).toFixed(2)) * 100).toFixed(2) %>%</td>
                    <!--Se Desconto for maior que o máximo Cria Bloqueio-->
                    <%
                     const percentualDesconto = Math.abs((((1-( item.valor / produto?.precoemb )).toFixed(2)) * 100).toFixed(2));
                     if (percentualDesconto > maxDescontoPermitido) {
                      bloqueioPorDesconto = true
                     }
                    %>

                    <script>function atualizarDesconto(id, valorDesconto) {
                      document.querySelector(`#${id}`).textContent = valorDesconto;
                    }</script>
                    <% 
                      descontoPedido = ( (produto?.precoemb * item.quantidade) - (item.valor * item.quantidade)  );
                      if (descontoPedido > 0) {
                        descontoTotal = descontoTotal + descontoPedido;
                        descontoTotal2 = descontoTotal2 + descontoPedido;
                      }
                    %>
                  </tr>
                <% contador++; } %>
              </tbody>
            </table>
            Desconto Total Calculado neste Pedido: R$ <%= descontoTotal.toFixed(2)  %>
            <% descontoTotal = 0; %>
          </div>
        </div>
      </div>
    <% }
    contI++;
  } %>
  </div>

  <div class="counter" style="text-align: -webkit-center;">
    <h2>Pedidos:</h2>
    <p><%= contadorPedido %> Pedidos</p>
    <h2>Descontos:</h2>
    <p>R$ <%= descontoTotal2.toFixed(2) %></p>
    <h2>Total Liquido:</h2>
    <p>R$ <%= valoresTotal.toFixed(2) %></p>
  </div>

  <script>
    window.onload = function() {
        // Exemplo de valores para exibir no contador
        let cont = contador;
        let valoresT = valoresTotal;

        // Aqui você pode buscar os valores atualizados a partir do seu back-end

        document.querySelector('.counter p:nth-child(2)').textContent = cont + ' Pedidos';
        document.querySelector('.counter p:nth-child(4)').textContent = valoresT;
    };
  </script>

<% if (!erroEncontrado && !bloqueioPorDesconto) { %>
  <div style="text-align: center;">
    <form id="somatizacaoForm" action="/enviaERP" method="POST" onsubmit="enviarFormulario(event)">
      <input type="hidden" id="somatizacaoData" name="somatizacaoData" value="<%= JSON.stringify(somatizacaoData) %>">
    </form>
    <div id="barraCarregamentoContainer" style="margin-top: 10px; display: none;">
      <div id="barraCarregamento" class="progress" style="height: 10px;">
        <div id="barraProgresso" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <!-- Adiciona um identificador ao botão para fácil manipulação no JavaScript -->
    <button type="button" class="btn btn-success" id="enviarBtn" style="margin-top: 20px;" onclick="iniciarEnvio()">Enviar a Discra</button>
    <!-- Adiciona estilos para centralizar o botão "Carregando..." -->
    <button type="button" class="btn btn-success" id="carregandoBtn" style="display: none; margin-top: 20px; position: absolute; left: 50%; transform: translateX(-50%);" disabled>Carregando...</button>
  </div>
<% } else { %>
  <div style="text-align: center;">
    <% if (bloqueioPorDesconto) {  %>
      <font color="red">POSSUI ITENS COM DESCONTO ACIMA DO PERMITIDO ( <%= maxDescontoPermitido %> ), ACIONE SEU SUPERVISOR</font></br>
    <% } %>
    <button type="submit" class="btn btn-danger" style="margin-top: 20px;">Erro Encontrado</button>
  </div>
<% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-mzpkfDs5L5SHu9I4Q5x2zrjFy5JgFD6Kw5g4F5ArxY6t0Fk5o5d3d7k5f5f5i5t5q5l5i5l5o5o5i5s5k5z5u5l5Y5G5O5B5F5M5M5F5M5M5F5S5E5" crossorigin="anonymous"></script>
  <script>
    const buttons = document.querySelectorAll('.accordion-button');
    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('aria-controls');
        const target = document.getElementById(targetId);
  
        // Verifique se o elemento de destino existe
        if (target) {
          const isExpanded = button.getAttribute('aria-expanded') === 'true';
  
          // Alterne o atributo 'aria-expanded' do botão
          button.setAttribute('aria-expanded', !isExpanded);
  
          // Exiba ou esconda o elemento de destino com base no estado atual
          target.style.display = isExpanded ? 'none' : 'block';
        }
      });
    });
  </script>
  <script>
    function iniciarEnvio() {
      // Esconde o botão de envio
      const enviarBtn = document.getElementById("enviarBtn");
      enviarBtn.style.display = "none";
  
      // Mostra o botão "Carregando..."
      const carregandoBtn = document.getElementById("carregandoBtn");
      carregandoBtn.style.display = "block";
  
      // Mostra a barra de carregamento
      const barraCarregamentoContainer = document.getElementById("barraCarregamentoContainer");
      barraCarregamentoContainer.style.display = "block";
  
      const barraProgresso = document.getElementById("barraProgresso");
      barraProgresso.style.width = "0%"; // Garante que a barra comece do zero
  
      let progresso = 0;
  
      // Adicione sua lógica de envio de formulário aqui
      // Simulando envio de formulário
      const interval = setInterval(() => {
        progresso += 1;
        barraProgresso.style.width = `${progresso}%`;
        barraProgresso.setAttribute("aria-valuenow", progresso);
  
        if (progresso === 100) {
          clearInterval(interval);
  
          // Esconde a barra de carregamento
          barraCarregamentoContainer.style.display = "none";
  
          // Exibe o botão "Carregando..." (desabilitado)
          carregandoBtn.style.display = "block";
          carregandoBtn.disabled = true;
  
          // Submeta o formulário
          document.getElementById("somatizacaoForm").submit();
        }
      }, 20); // Ajuste o intervalo conforme necessário para corresponder à sua simulação
    }
  </script>
  <style>
    .visualizado {
      background-color: #4deb4b;
      color: black;
    }
  </style>
</body>
</html>
