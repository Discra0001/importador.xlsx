name: Deploy to Production Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            # Definir vari√°veis
            CONTAINER_NAME="${{ secrets.CONTAINER_NAME }}"
            CONTAINER_PATH="${{ secrets.CONTAINER_PATH }}"
            
            echo "üöÄ Iniciando deployment..."
            echo "Container: $CONTAINER_NAME"
            echo "Path: $CONTAINER_PATH"
            
            # Verificar se o diret√≥rio existe
            if [ ! -d "$CONTAINER_PATH" ]; then
              echo "‚ùå Diret√≥rio $CONTAINER_PATH n√£o encontrado!"
              exit 1
            fi
            
            # Entrar no diret√≥rio
            cd "$CONTAINER_PATH"
            
            # Verificar se √© um reposit√≥rio git
            if [ ! -d ".git" ]; then
              echo "‚ö†Ô∏è Diret√≥rio n√£o √© um reposit√≥rio git. Inicializando..."
              git init
              git remote add origin https://github.com/Discra0001/importador.xlsx.git
            fi
            
            # Fazer pull das altera√ß√µes
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Instalar/Atualizar depend√™ncias
            echo "üì¶ Installing dependencies..."
            npm ci --production
            
            # Verificar se o container est√° rodando
            if docker ps | grep -q "$CONTAINER_NAME"; then
              echo "üîÑ Reiniciando container $CONTAINER_NAME..."
              docker restart "$CONTAINER_NAME"
            else
              echo "‚ö†Ô∏è Container n√£o est√° rodando. Iniciando..."
              docker start "$CONTAINER_NAME" || echo "Container precisa ser criado manualmente"
            fi
            
            # Verificar status do container
            echo "üìä Status do container:"
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Verificar logs recentes
            echo "üìã Logs recentes:"
            docker logs --tail 20 "$CONTAINER_NAME"
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
